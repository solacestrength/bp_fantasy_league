<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Metrics | British Classic Fantasy League 2025 ðŸ‡¬ðŸ‡§</title>

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <link rel="stylesheet" href="assets/css/fix-dropdown.css" />

  <style>
    body {background:#0b0b0b;color:#f1f1f1;font-family:'Inter',sans-serif;}
    select {background:#1f1f1f;border:1px solid #333;}
    canvas {max-width:100%;height:auto!important;}
    .chart-container {max-width:600px;margin:0 auto;position:relative;}

    /* Balanced chart heights */
    @media (min-width:1024px){
      .chart-container{max-width:500px;}
      #womenDonut, #menDonut {height:375px !important;} /* slightly taller donut */
      #womenHist, #menHist {height:395px !important;}   /* slightly shorter histogram */
    }
    @media (max-width:1023px){
      #womenDonut, #menDonut {height:336px !important;} /* +12% taller donut */
      #womenHist, #menHist {height:390px !important;}   /* -15% shorter histogram */
    }

    .collapsible-content{max-height:0;overflow:hidden;opacity:0;
      transition:max-height .5s ease,opacity .4s ease;}
    .collapsible-content.open{opacity:1;max-height:1000px;}
    .arrow{transition:transform .4s ease;}
    .arrow.rotate{transform:rotate(180deg);}
    .share-btn{background-color:#dc2626;display:flex;align-items:center;justify-content:center;
      border-radius:.5rem;height:36px;width:36px;transition:background-color .2s ease;}
    .share-btn:hover{background-color:#ef4444;}
    .share-icon{filter:invert(1);height:18px;width:18px;}

    @keyframes fadeInUp {0%{opacity:0;transform:translateY(10px);}100%{opacity:1;transform:translateY(0);}}
    .animate-fade-in-up{animation:fadeInUp 0.8s ease-out forwards;}
    .animate-fade-in{animation:fadeInUp 1s ease-out forwards;}
  </style>
</head>

<body class="relative bg-gray-900 text-white font-sans min-h-screen flex flex-col">
  <div class="absolute inset-0 bg-[url('bc25_logo.jpg')] bg-cover bg-center opacity-45"></div>
  <div class="absolute inset-0 bg-black/70"></div>

  <div class="relative z-10 flex flex-col flex-grow animate-fade-in">
    <header class="site-header w-full bg-gray-900/90 backdrop-blur-sm border-b border-gray-800 relative z-50">
      <div class="w-full flex items-center justify-center px-4 py-3">
        <div class="flex-1 text-center">
          <a href="index.html"
            class="font-bold text-white hover:text-red-500 transition text-sm sm:text-lg md:text-xl lg:text-2xl">
            British Classic Fantasy League 2025 ðŸ‡¬ðŸ‡§
          </a>
        </div>
        <div class="absolute right-4 top-1/2 -translate-y-1/2">
          <button id="menu-btn" aria-expanded="false"
            class="text-gray-300 p-2 rounded-md hover:bg-gray-800/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <div id="mobile-menu"
      class="fixed top-16 right-4 w-48 bg-gray-900/95 backdrop-blur-sm border border-gray-800 rounded-md shadow-lg z-50 scale-y-0 opacity-0 origin-top transition-transform duration-300 ease-in-out pointer-events-none">
      <nav class="flex flex-col py-2 text-white">
        <a href="index.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Home</a>
        <a href="entry.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">League Entry</a>
        <a href="leaderboard.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Leaderboard</a>
        <a href="accuracy_scores.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Accuracy Scores</a>
        <a href="metrics.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Metrics</a>
      </nav>
    </div>

    <main class="max-w-5xl mx-auto p-6 space-y-8 mt-6 animate-fade-in-up">
      <section class="text-center">
        <h2 class="text-xl font-semibold mb-1">Metrics Dashboard</h2>
        <p class="text-gray-400 text-sm">
          Explore how the predicted winners and totals are distributed for a given weight class. Sample size = number of entrants.
          User note - any labels that appear from tapping bars or chart sections will also be visible in your shared images ðŸ“Š
        </p>
      </section>

      <!-- WOMEN -->
      <div class="bg-black/60 rounded-lg p-4">
        <button onclick="toggleSection('women')" class="flex items-center justify-between w-full text-left text-lg font-bold">
          <span>Women</span>
          <svg id="arrow-women" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div id="women" class="collapsible-content mt-4">
          <select id="womenSelect" class="p-2 rounded mb-4 text-sm"></select>
          <div class="chart-container">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('womenDonut','F')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000" class="share-icon" alt="Share"/>
              </button>
            </div>
            <canvas id="womenDonut"></canvas>
          </div>
          <div class="chart-container mt-6">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('womenHist','F')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000" class="share-icon" alt="Share"/>
              </button>
            </div>
            <canvas id="womenHist"></canvas>
          </div>
        </div>
      </div>

      <!-- MEN -->
      <div class="bg-black/60 rounded-lg p-4">
        <button onclick="toggleSection('men')" class="flex items-center justify-between w-full text-left text-lg font-bold">
          <span>Men</span>
          <svg id="arrow-men" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div id="men" class="collapsible-content mt-4">
          <select id="menSelect" class="p-2 rounded mb-4 text-sm"></select>
          <div class="chart-container">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('menDonut','M')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000" class="share-icon" alt="Share"/>
              </button>
            </div>
            <canvas id="menDonut"></canvas>
          </div>
          <div class="chart-container mt-6">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('menHist','M')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000" class="share-icon" alt="Share"/>
              </button>
            </div>
            <canvas id="menHist"></canvas>
          </div>
        </div>
      </div>
    </main>

    <div class="flex justify-center mt-8">
      <a href="leaderboard.html" class="bg-gray-800/60 border border-gray-700 text-gray-200 font-semibold px-6 py-3 rounded-xl backdrop-blur-sm shadow-lg hover:bg-gray-700/70 hover:text-red-400 transition text-base">
        View Leaderboard
      </a>
    </div>
    <div class="flex justify-center mt-4">
      <a href="#top" class="bg-gray-800/60 border border-gray-700 text-gray-300 font-semibold px-5 py-2 rounded-xl backdrop-blur-sm shadow-lg hover:bg-gray-700/70 hover:text-red-400 transition text-sm">
        Back to Top
      </a>
    </div>

    <footer class="text-center text-gray-500 text-sm py-4 bg-transparent">
      Sponsored by the Sabado Sessions Podcast
    </footer>
  </div>

  <script src="assets/js/metrics-script.js"></script>
  <script>// ======= MENU =======
const menuBtn = document.getElementById('menu-btn');
const mobileMenu = document.getElementById('mobile-menu');
function toggleMenu(show){
  if(show){
    mobileMenu.classList.remove('scale-y-0','opacity-0','pointer-events-none');
    mobileMenu.classList.add('scale-y-100','opacity-100');
  }else{
    mobileMenu.classList.add('scale-y-0','opacity-0','pointer-events-none');
    mobileMenu.classList.remove('scale-y-100','opacity-100');
  }
}
let menuVisible=false;
menuBtn.addEventListener('click',e=>{menuVisible=!menuVisible;toggleMenu(menuVisible);e.stopPropagation();});
document.addEventListener('click',e=>{if(!mobileMenu.contains(e.target)&&!menuBtn.contains(e.target)){if(menuVisible){menuVisible=false;toggleMenu(false);}}});
toggleMenu(false);

// ======= CHART SETUP =======
Chart.register(ChartDataLabels);

const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSIS-QXBSLzVGyQYYIHf57zRmuSCSC9OmGSBMIOxhW2sB15SLTiVH_wPKcdThIoiqSulcypO1cf02HF/pub?gid=482892449&single=true&output=csv';
let allData = [];
const charts = {};

function sizing() {
  const desktop = window.matchMedia('(min-width: 1024px)').matches;
  return {
    donutTitle: desktop ? 22 : 14,
    donutSubtitle: desktop ? 18 : 12,
    donutLegend: desktop ? 18 : 12,
    donutPercent: desktop ? 16 : 12,
    histTitle: desktop ? 22 : 14,
    histSubtitle: desktop ? 18 : 12,
    axisTitle: desktop ? 18 : 12,
    axisTick: desktop ? 14 : 11,
    histBarLabel: desktop ? 12 : 10,
    exportWidth: desktop ? 1024 : 780,
    qrSize: desktop ? 96 : 72,
    creditFont: desktop ? 18 : 13,
    headerFont: desktop ? 32 : 20,
    subFont: desktop ? 26 : 16
  };
}

// ======= LOAD DATA =======
Papa.parse(SHEET_URL, {
  download: true,
  header: true,
  complete: r => {
    allData = r.data;
    setupDropdowns();
  }
});

function setupDropdowns(){
  ['F','M'].forEach(g=>{
    const d = allData.filter(r=>r.Gender===g);
    const classes = [...new Set(d.map(r=>r.Class))].sort((a,b)=>parseFloat(a)-parseFloat(b));
    const sel = document.getElementById(g==='F'?'womenSelect':'menSelect');
    sel.innerHTML = classes.map(c=>`<option value="${c}">${c}kg</option>`).join('');
    sel.onchange = ()=>renderCharts(g, sel.value);
    renderCharts(g, classes[0]);
  });
}

// ======= RENDER CHARTS =======
function renderCharts(g, w){
  const s = sizing();
  const donutId = g==='F'?'womenDonut':'menDonut';
  const histId  = g==='F'?'womenHist':'menHist';
  const rows = allData.filter(r=>r.Gender===g && r.Class===w);
  if(!rows.length) return;

  // --- DONUT ---
  const counts = {};
  rows.forEach(r => counts[r.Athlete] = (counts[r.Athlete]||0) + 1);
  const labels = Object.keys(counts);
  const data   = Object.values(counts);
  const totalVotes = data.reduce((a,b)=>a+b,0);
  const colors = ['#ef4444','#f97316','#facc15','#22c55e','#14b8a6','#3b82f6','#8b5cf6','#ec4899','#06b6d4','#84cc16','#d946ef','#fb7185'];

  if(charts[donutId]) charts[donutId].destroy();
  charts[donutId] = new Chart(document.getElementById(donutId),{
    type:'doughnut',
    data:{ labels, datasets:[{ data, backgroundColor:colors, borderColor:'#111', borderWidth:1 }]},
    options:{
      maintainAspectRatio:false,
      aspectRatio:1.05, // slightly taller donut (no squash)
      cutout:'55%',
      plugins:{
        title:{ display:true, text:'Share of Votes', color:'#ccc', font:{ weight:'bold', size:s.donutTitle }, padding:{ bottom:2 }},
        subtitle:{ display:true, text:`Total Votes â€“ ${totalVotes}`, color:'#aaa', font:{ weight:'normal', size:s.donutSubtitle }, padding:{ top:1,bottom:6 }},
        legend:{ position:'bottom', labels:{ color:'#ccc', boxWidth:10, boxHeight:10, font:{ size:s.donutLegend, weight:'normal' } }},
        datalabels:{
          color:'#fff', font:{ weight:'bold', size:s.donutPercent },
          formatter:(v)=>{const p=(v/totalVotes)*100;return p>=3?`${p.toFixed(1)}%`:'';},
          anchor:'center', align:'center', clamp:true
        }
      }
    },
    plugins:[ChartDataLabels]
  });

  // --- HISTOGRAM ---
  const totalsRaw = rows.map(r=>parseFloat(r.PredictedTotal)).filter(v=>!isNaN(v) && v>0);
  if(!totalsRaw.length){
    if(charts[histId]) charts[histId].destroy();
    charts[histId] = new Chart(document.getElementById(histId), {
      type:'bar',
      data:{ labels:[], datasets:[{ data:[] }]},
      options:{
        plugins:{
          title:{ display:true, text:'Distribution of Predicted Winning Totals', color:'#ccc', font:{ size:s.histTitle, weight:'bold' }},
          subtitle:{ display:true, text:`Total Votes â€“ 0`, color:'#aaa', font:{ size:s.histSubtitle }},
          legend:{ display:false }
        },
        scales:{
          x:{ ticks:{ color:'#ccc', font:{ size:s.axisTick }},
              title:{ display:true, text:'Predicted Total (kg)', color:'#ccc', font:{ size:s.axisTitle, weight:'bold' }}},
          y:{ ticks:{ color:'#ccc', font:{ size:s.axisTick }},
              title:{ display:true, text:'Frequency', color:'#ccc', font:{ size:s.axisTitle, weight:'bold' }}}
        }
      }
    });
    return;
  }

  const N = totalsRaw.length;
  const min = Math.min(...totalsRaw);
  const max = Math.max(...totalsRaw);
  const bins = Math.max(3, Math.round(Math.sqrt(N)));
  const bw = (max - min) / bins || 1;

  const countsHist = Array(bins).fill(0);
  totalsRaw.forEach(v => {
    let i = Math.floor((v - min) / bw);
    if(i >= bins) i = bins - 1;
    countsHist[i]++;
  });
  const binLabels = Array.from({length:bins},(_,i)=>`${(min+i*bw).toFixed(0)}â€“${(min+(i+1)*bw).toFixed(0)}`);

  if(charts[histId]) charts[histId].destroy();
  charts[histId] = new Chart(document.getElementById(histId),{
    type:'bar',
    data:{ labels:binLabels, datasets:[{ data:countsHist, backgroundColor:'#3b82f6', borderRadius:5 }]},
    options:{
      maintainAspectRatio:false,
      aspectRatio:0.85, // reduced height slightly
      plugins:{
        title:{ display:true, text:'Distribution of Predicted Winning Totals', color:'#ccc', font:{ size:s.histTitle, weight:'bold' }, padding:{ bottom:2 }},
        subtitle:{ display:true, text:`Total Votes â€“ ${N}`, color:'#aaa', font:{ size:s.histSubtitle, weight:'normal' }, padding:{ top:1, bottom:6 }},
        legend:{ display:false },
        datalabels:{
          anchor:'center', align:'center', color:'#fff', font:{ weight:'normal', size:s.histBarLabel },
          formatter:v=>v>0?v:''
        }
      },
      scales:{
        x:{ ticks:{ color:'#ccc', font:{ size:s.axisTick }},
            title:{ display:true, text:'Predicted Total (kg)', color:'#ccc', font:{ size:s.axisTitle, weight:'bold' }}},
        y:{ beginAtZero:true, ticks:{ color:'#ccc', font:{ size:s.axisTick }},
            title:{ display:true, text:'Frequency', color:'#ccc', font:{ size:s.axisTitle, weight:'bold' }},
            suggestedMax: Math.max(...countsHist)*1.15 }
      }
    },
    plugins:[ChartDataLabels]
  });
}

// ======= COLLAPSIBLE SECTIONS =======
function toggleSection(id){
  const c=document.getElementById(id);
  const a=document.getElementById(`arrow-${id}`);
  const open=c.classList.toggle('open');
  a.classList.toggle('rotate',open);
}

// ======= SHARE / EXPORT =======
async function shareChart(id, g) {
  const s = sizing();
  const srcCanvas = document.getElementById(id);
  await new Promise(requestAnimationFrame);

  const sel = document.getElementById(g === 'F' ? 'womenSelect' : 'menSelect');
  const w = sel.value;
  const titleMain = 'British Classic Fantasy League 2025 ðŸ‡¬ðŸ‡§';
  const titleSub = `${w}kg ${g === 'F' ? 'Women' : 'Men'}`;
  const isDonut = id.includes('Donut');
  const fileName = `metrics_${g}_${w}_${isDonut ? 'donut' : 'hist'}.png`;
  const isMobile = window.innerWidth < 768;

  const card = document.createElement('div');
  card.style.position='relative';
  card.style.width=s.exportWidth+'px';
  card.style.borderRadius='16px';
  card.style.overflow='hidden';
  card.style.margin='0 auto';
  card.style.backgroundImage="url('bc25_logo.jpg')";
  card.style.backgroundSize='cover';
  card.style.backgroundPosition='center';
  card.style.boxShadow='0 10px 25px rgba(0,0,0,0.35)';
  // Adjust export height balance
  card.style.minHeight=isDonut?(isMobile?'900px':'850px'):(isMobile?'860px':'780px');

  const overlay=document.createElement('div');
  overlay.style.position='absolute';
  overlay.style.inset='0';
  overlay.style.background='rgba(0,0,0,0.65)';
  card.appendChild(overlay);

  const inner=document.createElement('div');
  inner.style.position='relative';
  inner.style.padding=isDonut?(isMobile?'34px 24px 28px':'30px 28px 26px'):(isMobile?'42px 28px 26px':'36px 28px 24px');
  inner.style.textAlign='center';
  inner.style.color='#fff';
  inner.style.fontFamily="'Inter',sans-serif";
  inner.style.zIndex='2';

  const header=document.createElement('h2');
  header.textContent=titleMain;
  header.style.fontSize=isMobile?s.headerFont*1.5+'px':s.headerFont*1.25+'px';
  header.style.fontWeight='700';
  header.style.margin='0 0 4px 0';

  const sub=document.createElement('p');
  sub.textContent=titleSub;
  sub.style.fontSize=isMobile?s.subFont*1.5+'px':s.subFont*1.25+'px';
  sub.style.fontWeight='700';
  sub.style.color='#ddd';
  sub.style.margin='0 0 14px 0';

  const dataURL=srcCanvas.toDataURL('image/png');
  const img=new Image();
  img.src=dataURL;
  img.style.display='block';
  img.style.borderRadius='8px';
  img.style.margin=isDonut?'0 auto 20px auto':'0 auto 10px auto';
  img.style.width=isDonut?(isMobile?'80%':'70%'):(isMobile?'96%':'93%');
  img.style.height='auto';
  await img.decode();

  const credit=document.createElement('p');
  credit.style.fontSize=isMobile?s.creditFont*1.25+'px':s.creditFont*1.15+'px';
  credit.style.color='#ccc';
  credit.style.lineHeight='1.5';
  credit.style.marginTop='8px';
  credit.innerHTML='Data from tinyurl.com/britishclassicfl-metrics<br><br>Sponsored by the Sabado Sessions Podcast';

  const qr=new Image();
  qr.crossOrigin='anonymous';
  const qrSize=isMobile?s.qrSize*1.1:s.qrSize*1.25;
  qr.src=`https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent('https://solacestrength.github.io/britishclassicfl/metrics.html')}`;
  qr.style.position='absolute';
  qr.style.bottom='18px';
  qr.style.left='18px';
  qr.style.width=qrSize+'px';
  qr.style.height=qrSize+'px';
  qr.style.borderRadius='6px';
  qr.style.opacity='0.95';

  inner.append(header, sub, img, credit);
  card.append(inner, qr);
  document.body.appendChild(card);

  const canvas=await html2canvas(card,{backgroundColor:null,scale:2,useCORS:true,scrollY:0});
  card.remove();

  const blob=await new Promise(r=>canvas.toBlob(r,'image/png'));
  const file=new File([blob],fileName,{type:'image/png'});

  if(navigator.canShare&&navigator.canShare({files:[file]})){
    try{
      await navigator.share({title:'British Classic Fantasy League 2025',text:'Check out these British Classic Fantasy League stats!',files:[file]});
    }catch(e){}
  }else{
    const link=document.createElement('a');
    link.href=canvas.toDataURL('image/png');
    link.download=fileName;
    link.click();
  }
}
  </script>
</body>
</html>
