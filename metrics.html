<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Metrics | British Classic Fantasy League 2025 ðŸ‡¬ðŸ‡§</title>

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <link rel="stylesheet" href="assets/css/fix-dropdown.css" />

<style>
  /* === Base Reset === */
  html, body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    background-color: #0f172a; /* consistent with your theme */
    font-family: system-ui, sans-serif;
  }

  /* === Chart Containers === */
  canvas {
    display: block;
    margin: 0 auto;
    max-width: 100%;
    height: auto;
    border-radius: 12px;
  }

  /* === Donut Containers === */
  .donut-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* === Histogram Containers === */
.hist-wrapper {
  position: relative;
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* Stable, JS-managed canvas sizing */
.hist-wrapper canvas {
  display: block;
  width: 100% !important;
  height: auto !important;
  max-height: 520px;
  aspect-ratio: 1.2 / 1; /* gives balanced look for axes */
  border-radius: 12px;
}

/* Mobile tuning (taller but controlled) */
@media (max-width: 480px) {
  .hist-wrapper canvas {
    aspect-ratio: 0.9 / 1;
    max-height: 500px;
  }
}

/* Tablet */
@media (min-width: 481px) and (max-width: 1024px) {
  .hist-wrapper canvas {
    aspect-ratio: 1.1 / 1;
    max-height: 560px;
  }
}

/* Desktop */
@media (min-width: 1025px) {
  .hist-wrapper canvas {
    aspect-ratio: 1.2 / 1;
    max-height: 600px;
  }
}

  /* === Dropdown & Share Button Placement === */
  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 0.25rem 0.5rem 0.5rem;
    box-sizing: border-box;
  }

  select {
    background-color: rgba(255,255,255,0.08);
    color: #eee;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 6px;
    font-size: 0.95rem;
    padding: 0.25rem 0.75rem;
    appearance: none;
    -webkit-appearance: none;
  }

  select:focus {
    outline: none;
    border-color: #38bdf8;
  }

  .share-btn {
    background-color: #ef4444;
    color: white;
    padding: 0.6rem 0.7rem;
    border-radius: 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .share-btn:hover {
    background-color: #dc2626;
  }

  /* === Collapsible Sections === */
  .collapsible {
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    background-color: rgba(30,41,59,0.6);
    margin-bottom: 1.25rem;
    padding: 0.75rem 1rem;
    transition: all 0.4s ease;
    overflow: hidden;
  }

  .collapsible.open {
    background-color: rgba(30,41,59,0.85);
  }

  .collapsible-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: bold;
    color: #eee;
    cursor: pointer;
    font-size: 1.15rem;
  }

  .collapsible-content {
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition: all 0.6s ease;
  }

  .collapsible-content.open {
    opacity: 1;
    max-height: 2000px;
  }

  /* === Bottom Buttons === */
  #bottomBackToTop,
  .view-leaderboard {
    transition: margin-top 0.6s ease;
  }

  .view-leaderboard a {
    background-color: rgba(255,255,255,0.08);
    color: #f3f4f6;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: background-color 0.3s ease;
  }

  .view-leaderboard a:hover {
    background-color: rgba(255,255,255,0.15);
  }

  /* === Footer === */
  footer {
    margin-top: 1.5rem;
    text-align: center;
    font-size: 0.9rem;
    color: #94a3b8;
  }
</style>
</head>

<body class="relative bg-gray-900 text-white font-sans min-h-screen flex flex-col">
  <div class="absolute inset-0 bg-[url('bc25_logo.jpg')] bg-cover bg-center opacity-45"></div>
  <div class="absolute inset-0 bg-black/70"></div>

  <div class="relative z-10 flex flex-col flex-grow animate-fade-in">
    <!-- HEADER -->
    <header class="site-header w-full bg-gray-900/90 backdrop-blur-sm border-b border-gray-800 relative z-50">
      <div class="w-full flex items-center justify-center px-4 py-3">
        <div class="flex-1 text-center">
          <a href="index.html"
             class="font-bold text-white hover:text-red-500 transition text-sm sm:text-lg md:text-xl lg:text-2xl">
            British Classic Fantasy League 2025 ðŸ‡¬ðŸ‡§
          </a>
        </div>
        <div class="absolute right-4 top-1/2 -translate-y-1/2">
          <button id="menu-btn" aria-expanded="false"
                  class="text-gray-300 p-2 rounded-md hover:bg-gray-800/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- MOBILE MENU -->
    <div id="mobile-menu"
         class="fixed top-16 right-4 w-48 bg-gray-900/95 backdrop-blur-sm border border-gray-800 rounded-md
                shadow-lg z-50 scale-y-0 opacity-0 origin-top transition-transform duration-300 ease-in-out
                pointer-events-none">
      <nav class="flex flex-col py-2 text-white">
        <a href="index.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Home</a>
        <a href="entry.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">League Entry</a>
        <a href="leaderboard.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Leaderboard</a>
        <a href="accuracy_scores.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Accuracy Scores</a>
        <a href="metrics.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Metrics</a>
      </nav>
    </div>

    <!-- MAIN -->
    <main class="max-w-5xl mx-auto p-6 space-y-8 mt-6 animate-fade-in-up">
      <section class="text-center">
        <h2 class="text-xl font-semibold mb-1">Metrics Dashboard</h2>
        <p class="text-gray-400 text-sm">
          Explore how the predicted winners and totals are distributed for a given weight class. Sample size = number of entrants.
          Any labels from tapping bars or chart sections will be visible in shared images ðŸ“Š
        </p>
      </section>

      <!-- WOMEN -->
      <div class="bg-gray-800/60 border border-gray-700 backdrop-blur-sm shadow-lg rounded-2xl p-4">
        <button onclick="toggleSection('women')"
                class="flex items-center justify-between w-full text-left text-lg font-bold">
          <span>Women</span>
          <svg id="arrow-women" xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div id="women" class="collapsible-content mt-4">
          <select id="womenSelect" class="p-2 rounded mb-4 text-sm"></select>

          <div class="chart-container">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('womenDonut','F')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000"
                     class="share-icon" alt="Share"/>
              </button>
            </div>
            <canvas id="womenDonut"></canvas>
          </div>

          <div class="chart-container mt-6">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('womenHist','F')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000"
                     class="share-icon" alt="Share"/>
              </button>
            </div>
            <canvas id="womenHist"></canvas>
          </div>
        </div>
      </div>

      <!-- MEN -->
      <div class="bg-gray-800/60 border border-gray-700 backdrop-blur-sm shadow-lg rounded-2xl p-4">
        <button onclick="toggleSection('men')"
                class="flex items-center justify-between w-full text-left text-lg font-bold">
          <span>Men</span>
          <svg id="arrow-men" xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div id="men" class="collapsible-content mt-4">
          <select id="menSelect" class="p-2 rounded mb-4 text-sm"></select>

          <div class="chart-container">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('menDonut','M')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000"
                     class="share-icon" alt="Share"/>
              </button>
            </div>
            <canvas id="menDonut"></canvas>
          </div>

          <div class="chart-container mt-6">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('menHist','M')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000"
                     class="share-icon" alt="Share"/>
              </button>
            </div>
            <canvas id="menHist"></canvas>
          </div>
        </div>
      </div>
    </main>

    <!-- VIEW LEADERBOARD BUTTON -->
    <div class="flex justify-center mt-8">
      <a href="leaderboard.html"
         class="inline-flex items-center justify-center bg-gray-800/60 border border-gray-700
                text-gray-200 font-semibold px-6 py-3 rounded-full backdrop-blur-sm shadow-lg
                hover:bg-gray-700/70 hover:text-red-400 transition text-sm">
        View Leaderboard
      </a>
    </div>

    <!-- BACK TO TOP BUTTON -->
    <div class="flex justify-center mt-8">
      <button id="bottomBackToTop"
              class="bg-gray-800/60 border border-gray-700 text-red-500 w-10 h-10 rounded-full
                     flex items-center justify-center backdrop-blur-sm shadow-lg
                     hover:bg-gray-700/70 hover:text-red-400 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
      </button>
    </div>

    <footer class="text-center text-gray-500 text-sm py-4 bg-transparent">
      Sponsored by the Sabado Sessions Podcast
    </footer>
  </div>

<script>
/* ========= CHART.JS PLUGINS ========= */
/* Only use DataLabels. All custom centering hacks removed. */
Chart.register(ChartDataLabels);

/* ========= DATA SOURCE ========= */
const SHEET_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSIS-QXBSLzVGyQYYIHf57zRmuSCSC9OmGSBMIOxhW2sB15SLTiVH_wPKcdThIoiqSulcypO1cf02HF/pub?gid=482892449&single=true&output=csv';

let allData = [];
const charts = {}; // hold chart instances by canvas id

/* ========= RESPONSIVE FONT SIZES ========= */
function sizing() {
  const desktop = window.matchMedia('(min-width:1024px)').matches;
  return {
    donutTitle:    desktop ? 22 : 16,
    donutSubtitle: desktop ? 18 : 13,
    donutLegend:   desktop ? 16 : 11,
    donutPercent:  desktop ? 16 : 12,
    histTitle:     desktop ? 22 : 16,
    histSubtitle:  desktop ? 18 : 13,
    axisTitle:     desktop ? 16 : 12,
    axisTick:      desktop ? 13 : 10,
    histBarLabel:  desktop ? 11 : 9,
  };
}

/* ========= MOBILE MENU ========= */
const menuBtn = document.getElementById('menu-btn');
const mobileMenu = document.getElementById('mobile-menu');
let menuVisible = false;

function toggleMenu(show) {
  if (show) {
    mobileMenu.classList.remove('scale-y-0','opacity-0','pointer-events-none');
    mobileMenu.classList.add('scale-y-100','opacity-100');
  } else {
    mobileMenu.classList.add('scale-y-0','opacity-0','pointer-events-none');
    mobileMenu.classList.remove('scale-y-100','opacity-100');
  }
}
toggleMenu(false);

if (menuBtn) {
  menuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    menuVisible = !menuVisible;
    toggleMenu(menuVisible);
  });
}
document.addEventListener('click', (e) => {
  if (!mobileMenu.contains(e.target) && !menuBtn.contains(e.target) && menuVisible) {
    menuVisible = false;
    toggleMenu(false);
  }
});

/* ========= LOAD CSV + INIT ========= */
Papa.parse(SHEET_URL, {
  download: true,
  header: true,
  complete: (res) => {
    allData = res.data || [];
    setupDropdowns();
  }
});

function setupDropdowns() {
  ['F', 'M'].forEach((g) => {
    const rows = allData.filter(r => r.Gender === g);
    const classes = [...new Set(rows.map(r => r.Class))]
      .filter(Boolean)
      .sort((a, b) => parseFloat(a) - parseFloat(b));

    const select = document.getElementById(g === 'F' ? 'womenSelect' : 'menSelect');
    if (!select || !classes.length) return;

    select.innerHTML = classes.map(c => `<option value="${c}">${c}kg</option>`).join('');
    select.onchange = () => renderCharts(g, select.value);

    renderCharts(g, classes[0]);
  });
}

/* ========= RENDER CHARTS (DONUT + HISTOGRAM) ========= */

function renderCharts(g, w) {
  const s = sizing();
  const donutId = g === 'F' ? 'womenDonut' : 'menDonut';
  const histId  = g === 'F' ? 'womenHist'  : 'menHist';

  const rows = allData.filter(r => r.Gender === g && r.Class === w);
  if (!rows.length) {
    if (charts[donutId]) charts[donutId].destroy();
    if (charts[histId]) charts[histId].destroy();
    return;
  }

  /* ----- DONUT: Share of Votes ----- */
  const counts = {};
  rows.forEach(r => {
    counts[r.Athlete] = (counts[r.Athlete] || 0) + 1;
  });

  const dLabels = Object.keys(counts);
  const dData   = Object.values(counts);
  const total   = dData.reduce((a, b) => a + b, 0);

  const colors = [
    '#ef4444','#f97316','#facc15','#22c55e','#14b8a6',
    '#3b82f6','#8b5cf6','#ec4899','#06b6d4','#84cc16',
    '#d946ef','#fb7185'
  ];

  if (charts[donutId]) charts[donutId].destroy();
  charts[donutId] = new Chart(document.getElementById(donutId), {
    type: 'doughnut',
    data: {
      labels: dLabels,
      datasets: [{
        data: dData,
        backgroundColor: colors,
        borderColor: '#111',
        borderWidth: 1
      }]
    },
    options: {
      maintainAspectRatio: true,
      aspectRatio: 1,
      cutout: '57%',
      layout: {
        padding: { top: 16, right: 16, bottom: 16, left: 16 }
      },
      plugins: {
        title: {
          display: true,
          text: 'Share of Votes',
          color: '#f3f4f6',
          font: { weight: 'bold', size: s.donutTitle },
          padding: { bottom: 4 }
        },
        subtitle: {
          display: true,
          text: `Total Votes â€“ ${total}`,
          color: '#9ca3af',
          font: { size: s.donutSubtitle },
          padding: { top: 0, bottom: 10 }
        },
        legend: {
          position: 'bottom',
          labels: {
            color: '#e5e7eb',
            boxWidth: 10,
            boxHeight: 10,
            font: { size: s.donutLegend }
          }
        },
        datalabels: {
          color: '#fff',
          font: { weight: 'bold', size: s.donutPercent },
          formatter: (v) => {
            const p = (v / total) * 100;
            return p >= 3 ? `${p.toFixed(1)}%` : '';
          },
          anchor: 'center',
          align: 'center',
          clamp: true
        }
      }
    }
  });

  /* ----- HISTOGRAM: Distribution of Predicted Totals ----- */

  const vals = rows
    .map(r => parseFloat(r.PredictedTotal))
    .filter(v => !isNaN(v) && v > 0);

  if (!vals.length) {
    if (charts[histId]) charts[histId].destroy();
    return;
  }

  const N    = vals.length;
  const min  = Math.min(...vals);
  const max  = Math.max(...vals);
  const bins = Math.max(3, Math.round(Math.sqrt(N)));
  const bw   = (max - min) / bins || 1;

  const countsH = Array(bins).fill(0);
  vals.forEach(v => {
    let i = Math.floor((v - min) / bw);
    if (i >= bins) i = bins - 1;
    if (i < 0) i = 0;
    countsH[i]++;
  });

  const labelsH = Array.from({ length: bins }, (_, i) =>
    `${(min + i * bw).toFixed(0)}â€“${(min + (i + 1) * bw).toFixed(0)}`
  );

  const minC = Math.min(...countsH);
  const maxC = Math.max(...countsH);
  const yMin = Math.max(0, Math.floor(minC / 2));
  const span = maxC - yMin || 1;
  const step = Math.max(1, Math.round(span / 4));
  const yMax = Math.ceil((maxC + 0.01) / step) * step;

  if (charts[histId]) charts[histId].destroy();
  charts[histId] = new Chart(document.getElementById(histId), {
    type: 'bar',
    data: {
      labels: labelsH,
      datasets: [{
        data: countsH,
        backgroundColor: '#3b82f6',
        borderRadius: 5,
        barPercentage: 0.9,
        categoryPercentage: 0.9
      }]
    },
    options: {
      maintainAspectRatio: true,
      aspectRatio: 1,
      layout: {
        // Symmetric padding so chart (axes + bars) naturally centers in container
        padding: { top: 18, right: 18, bottom: 26, left: 18 }
      },
      plugins: {
        title: {
          display: true,
          text: 'Distribution of Predicted Winning Totals',
          color: '#f3f4f6',
          font: { size: s.histTitle, weight: 'bold' },
          padding: { bottom: 4 }
        },
        subtitle: {
          display: true,
          text: `Total Votes â€“ ${N}`,
          color: '#9ca3af',
          font: { size: s.histSubtitle },
          padding: { top: 0, bottom: 10 }
        },
        legend: { display: false },
        datalabels: {
          color: '#ffffff',
          font: { size: s.histBarLabel },
          formatter: (v) => (v > 0 ? v : ''),
          anchor: 'end',
          align: 'end',
          clamp: true
        }
      },
      scales: {
        x: {
          offset: true,
          ticks: {
            color: '#e5e7eb',
            font: { size: s.axisTick },
            maxRotation: 60,
            minRotation: 60
          },
          title: {
            display: true,
            text: 'Predicted Total (kg)',
            color: '#e5e7eb',
            font: { size: s.axisTitle, weight: 'bold' }
          },
          grid: { display: false }
        },
        y: {
          min: yMin,
          max: yMax,
          beginAtZero: false,
          ticks: {
            color: '#e5e7eb',
            font: { size: s.axisTick },
            stepSize: step
          },
          title: {
            display: true,
            text: 'Vote Count',
            color: '#e5e7eb',
            font: { size: s.axisTitle, weight: 'bold' }
          },
          grid: { color: 'rgba(148,163,253,0.06)' }
        }
      }
    }
  });
}

/* ========= COLLAPSIBLES + BOTTOM BUTTON POSITIONING ========= */

function toggleSection(id) {
  const c = document.getElementById(id);
  const a = document.getElementById(`arrow-${id}`);
  const main = document.querySelector('main');
  if (!c || !a || !main) return;

  const open = c.classList.toggle('open');
  a.classList.toggle('rotate', open);

  if (open) {
    const wrapper = c.closest('.bg-gray-800\\/60') || c;
    wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // Optional: add a class when any section is open (for subtle spacing tweaks)
  const anyOpen = document.querySelector('.collapsible-content.open');
  if (anyOpen) {
    main.classList.add('expanded');
  } else {
    main.classList.remove('expanded');
  }

  setTimeout(repositionBottomButtons, 350);
}

function repositionBottomButtons() {
  const main = document.querySelector('main');
  const leaderboard = document.querySelector('a[href="leaderboard.html"]')?.closest('div');
  const backToTopWrapper = document.getElementById('bottomBackToTop')?.closest('div');
  if (!main || !leaderboard || !backToTopWrapper) return;

  const contentHeight = main.scrollHeight;
  const viewport = window.innerHeight;
  const baseOffset = 32;

  const extra = Math.max(0, viewport - contentHeight);
  const topMargin = baseOffset + extra * 0.4;

  leaderboard.style.transition = 'margin-top 0.35s ease';
  backToTopWrapper.style.transition = 'margin-top 0.35s ease';

  leaderboard.style.marginTop = `${topMargin}px`;
  backToTopWrapper.style.marginTop = `16px`;
}

window.addEventListener('resize', repositionBottomButtons);

/* ========= SHARE / EXPORT + BACK TO TOP (unchanged from your working version) ========= */
/* Keeping your existing shareChart + helpers exactly as-is to avoid regression.
   Only difference above is the histogram centering plugin. */

function detectBrowserShareSupport() {
  const ua = navigator.userAgent.toLowerCase();
  return {
    isAndroidChrome:
      ua.includes('android') && ua.includes('chrome') && !ua.includes('edge') && !ua.includes('opr'),
    isChromeIOS: ua.includes('crios')
  };
}

function swapShareButtonFor(containerEl, newBtn) {
  containerEl.innerHTML = '';
  containerEl.appendChild(newBtn);
}

function scaleChartFonts(chart, factor) {
  const edits = [];
  function walk(obj) {
    if (!obj || typeof obj !== 'object') return;
    if (obj.font && typeof obj.font.size === 'number') {
      edits.push({ font: obj.font, original: obj.font.size });
      obj.font.size = Math.round(obj.font.size * factor);
    }
    for (const key in obj) {
      if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;
      const val = obj[key];
      if (val && typeof val === 'object') walk(val);
    }
  }
  walk(chart.options);
  return function restore() {
    edits.forEach(e => { e.font.size = e.original; });
  };
}

async function shareChart(id, g) {
  const { isAndroidChrome, isChromeIOS } = detectBrowserShareSupport();
  const s = sizing();
  const src = document.getElementById(id);
  if (!src) return;

  const shareBar = src.previousElementSibling;
  if (!shareBar) return;

  function makeBtn(text) {
    const b = document.createElement('button');
    b.className = "bg-red-600 hover:bg-red-500 text-white rounded-full text-xs font-semibold shadow-md px-3 py-1";
    b.style.minWidth = "140px";
    b.style.height = "24px";
    b.textContent = text;
    return b;
  }

  const generatingBtn = makeBtn("Generatingâ€¦");
  swapShareButtonFor(shareBar, generatingBtn);

  await new Promise(requestAnimationFrame);
  const chart = Chart.getChart(src);
  if (!chart) return;

  const sel = document.getElementById(g === 'F' ? 'womenSelect' : 'menSelect');
  const w = sel ? sel.value : '';
  const isDonut = id.includes('Donut');
  const isMobile = window.innerWidth < 768;
  const fn = `metrics_${g}_${w || 'class'}_${isDonut ? 'donut' : 'hist'}.png`;

  const parent = src.closest('.collapsible-content');
  if (parent && parent.style.maxHeight === '0px') {
    parent.style.maxHeight = parent.scrollHeight + 'px';
    parent.style.opacity = '1';
    await new Promise(requestAnimationFrame);
  }

  let prevScales = null;
  if (chart.options.scales) {
    prevScales = JSON.parse(JSON.stringify(chart.options.scales));
    if (chart.options.scales.x) chart.options.scales.x.grid.display = false;
    if (chart.options.scales.y) chart.options.scales.y.grid.display = false;
    chart.update();
    await new Promise(requestAnimationFrame);
  }

  let restoreFonts = null;
  if (!isDonut) {
    restoreFonts = scaleChartFonts(chart, 0.85);
    chart.update();
    await new Promise(requestAnimationFrame);
  }

  const card = document.createElement('div');
  card.style.position = 'relative';
  card.style.width = s.exportWidth + 'px';
  card.style.borderRadius = '16px';
  card.style.overflow = 'hidden';
  card.style.margin = '0 auto';
  card.style.backgroundImage = "url('bc25_logo.jpg')";
  card.style.backgroundSize = 'cover';
  card.style.backgroundPosition = 'center';
  card.style.boxShadow = '0 10px 25px rgba(0,0,0,0.35)';

  const overlay = document.createElement('div');
  overlay.style.position = 'absolute';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(0,0,0,0.65)';
  card.appendChild(overlay);

  const inner = document.createElement('div');
  inner.style.position = 'relative';
  inner.style.textAlign = 'center';
  inner.style.color = '#fff';
  inner.style.fontFamily = "'Inter', sans-serif";
  inner.style.zIndex = '2';
  inner.style.padding = isDonut ? '36px 28px 36px 28px' : '40px 28px 36px 28px';
  card.appendChild(inner);

  const header = document.createElement('h2');
  header.textContent = 'British Classic Fantasy League 2025 ðŸ‡¬ðŸ‡§';
  header.style.fontSize = (isMobile ? s.headerFont * 1.5 : s.headerFont * 1.25) + 'px';
  header.style.fontWeight = '700';
  header.style.margin = '0 0 4px 0';

  const sub = document.createElement('p');
  sub.textContent = (w ? `${w}kg ` : '') + (g === 'F' ? 'Women' : 'Men');
  sub.style.fontSize = (isMobile ? s.subFont * 1.5 : s.subFont * 1.25) + 'px';
  sub.style.fontWeight = '700';
  sub.style.color = '#ddd';
  sub.style.margin = '0 0 14px 0';

  const dataURL = src.toDataURL('image/png');
  const img = new Image();
  img.src = dataURL;
  await img.decode();
  img.style.display = 'block';
  img.style.margin = '0 auto 18px auto';
  img.style.borderRadius = '8px';
  img.style.width = (isMobile ? (isDonut ? '80%' : '96%') : (isDonut ? '70%' : '93%'));
  img.style.height = 'auto';

  const credit = document.createElement('p');
  credit.style.fontSize = (isMobile ? s.creditFont * 1.25 : s.creditFont * 1.15) + 'px';
  credit.style.color = '#ccc';
  credit.style.lineHeight = '1.5';
  credit.style.marginTop = '8px';
  credit.innerHTML =
    'Data from tinyurl.com/britishclassicfl-metrics<br><br>Sponsored by the Sabado Sessions Podcast';

  const spacer = document.createElement('div');
  spacer.style.height = isDonut ? '14px' : '28px';

  const qr = new Image();
  qr.crossOrigin = 'anonymous';
  const qrsz = isMobile ? s.qrSize * 1.1 : s.qrSize * 1.25;
  qr.src = `https://api.qrserver.com/v1/create-qr-code/?size=${qrsz}x${qrsz}&data=${encodeURIComponent(
    'https://solacestrength.github.io/britishclassicfl/metrics.html'
  )}`;
  qr.style.position = 'absolute';
  qr.style.bottom = '18px';
  qr.style.left = '18px';
  qr.style.width = qrsz + 'px';
  qr.style.height = qrsz + 'px';
  qr.style.borderRadius = '6px';
  qr.style.opacity = '0.95';

  inner.append(header, sub, img, credit, spacer);
  card.appendChild(qr);
  document.body.appendChild(card);

  await new Promise(requestAnimationFrame);

  const naturalH = card.scrollHeight;
  const baseH = isDonut ? 860 : 820;
  const scaleFactor = isMobile ? 0.92 : 1.0;
  const fixedH = Math.min(naturalH * scaleFactor, s.exportWidth * scaleFactor);
  const buffer = Math.round(
    fixedH * (isMobile ? (isDonut ? 0.15 : 0.22) : 0.02)
  );

  card.style.height = fixedH + buffer + 'px';
  card.style.maxHeight = fixedH + buffer + 'px';
  card.style.minHeight = (baseH * scaleFactor) + 'px';

  await new Promise(requestAnimationFrame);

  const canvas = await html2canvas(card, {
    backgroundColor: null,
    scale: 2,
    useCORS: true,
    scrollY: 0
  });
  card.remove();

  if (restoreFonts) restoreFonts();
  if (prevScales) chart.options.scales = prevScales;
  chart.update();

  const blob = await new Promise((r) => canvas.toBlob(r, 'image/png'));
  const file = new File([blob], fn, { type: 'image/png' });

  if (isAndroidChrome) {
    const shareBtn = makeBtn("Share Generated Image");
    shareBtn.onclick = async () => {
      try {
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: 'British Classic Fantasy League 2025',
            text: 'Check out these stats!',
            files: [file]
          });
        } else {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = fn;
          link.click();
          URL.revokeObjectURL(link.href);
        }
      } catch (e) {}
      resetShareIcon();
    };
    swapShareButtonFor(shareBar, shareBtn);
    return;
  }

  try {
    if (!isChromeIOS && navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        title: 'British Classic Fantasy League 2025',
        text: 'Check out these stats!',
        files: [file]
      });
    } else {
      const url = URL.createObjectURL(file);
      const link = document.createElement('a');
      link.href = url;
      link.download = fn;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }
  } catch (err) {
    console.error('Share failed:', err);
  }

  resetShareIcon();

  function resetShareIcon() {
    shareBar.innerHTML = '';
    const iconBtn = document.createElement('button');
    iconBtn.className = 'share-btn';
    iconBtn.onclick = () => shareChart(id, g);
    iconBtn.innerHTML =
      '<img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000" class="share-icon" alt="Share"/>';
    shareBar.appendChild(iconBtn);
  }
}

/* BACK TO TOP */
const bottomBackToTop = document.getElementById('bottomBackToTop');
if (bottomBackToTop) {
  bottomBackToTop.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
}
</script>
</body>
</html>
