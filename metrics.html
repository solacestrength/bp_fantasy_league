<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Metrics | British Classic Fantasy League 2025 ðŸ‡¬ðŸ‡§</title>

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- âœ… Correct UMD build for QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.umd.min.js"></script>
  <script>
    window.QRCode = window.QRCode || QRCode; // ensures global availability
  </script>

  <link rel="stylesheet" href="assets/css/fix-dropdown.css" />

  <style>
    body {background:#0b0b0b;color:#f1f1f1;font-family:'Inter',sans-serif;}
    select {background:#1f1f1f;border:1px solid #333;}
    canvas {max-width:100%;height:auto!important;}
    .chart-container {max-width:600px;margin:0 auto;}
    @media(min-width:1024px){.chart-container{max-width:500px;}}
    .collapsible-content{max-height:0;overflow:hidden;opacity:0;transition:max-height .5s ease,opacity .4s ease;}
    .collapsible-content.open{opacity:1;max-height:1000px;}
    .arrow{transition:transform .4s ease;}
    .arrow.rotate{transform:rotate(180deg);}
    .share-btn{background-color:#dc2626;display:flex;align-items:center;justify-content:center;
      border-radius:.5rem;height:36px;width:36px;transition:background-color .2s ease;}
    .share-btn:hover{background-color:#ef4444;}
    .share-icon{filter:invert(1);height:18px;width:18px;}
  </style>
</head>

<body class="relative bg-gray-900 text-white font-sans min-h-screen flex flex-col">
  <div class="absolute inset-0 bg-[url('bc25_logo.jpg')] bg-cover bg-center opacity-45"></div>
  <div class="absolute inset-0 bg-black/70"></div>

  <div class="relative z-10 flex flex-col flex-grow">
    <header class="site-header w-full bg-gray-900/90 backdrop-blur-sm border-b border-gray-800 relative z-50">
      <div class="w-full flex items-center justify-center px-4 py-3">
        <div class="flex-1 text-center">
          <a href="index.html" class="font-bold text-white hover:text-red-500 transition text-lg">
            British Classic Fantasy League 2025 ðŸ‡¬ðŸ‡§
          </a>
        </div>
        <div class="absolute right-4 top-1/2 -translate-y-1/2">
          <button id="menu-btn" class="text-gray-300 p-2 rounded-md hover:bg-gray-800/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="fixed top-16 right-4 w-48 bg-gray-900/95 border border-gray-800 rounded-md shadow-lg scale-y-0 opacity-0 origin-top transition-transform duration-300 ease-in-out pointer-events-none">
      <nav class="flex flex-col py-2 text-white">
        <a href="index.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Home</a>
        <a href="entry.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">League Entry</a>
        <a href="leaderboard.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Leaderboard</a>
        <a href="accuracy_scores.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Accuracy Scores</a>
        <a href="metrics.html" class="px-4 py-2 hover:text-red-500 hover:bg-gray-800 transition">Metrics</a>
      </nav>
    </div>

    <main class="max-w-5xl mx-auto p-6 space-y-8 mt-6">
      <section class="text-center">
        <h2 class="text-xl font-semibold mb-1">Metrics Dashboard</h2>
        <p class="text-gray-400 text-sm">Explore distributions for each weight class. Tap bars or chart sections to reveal labels before sharing.</p>
      </section>

      <!-- WOMEN -->
      <div class="bg-black/60 rounded-lg p-4">
        <button onclick="toggleSection('women')" class="flex items-center justify-between w-full text-left text-lg font-bold">
          <span>Women</span>
          <svg id="arrow-women" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div id="women" class="collapsible-content mt-4">
          <select id="womenSelect" class="p-2 rounded mb-4 text-sm"></select>
          <div class="chart-container">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('womenDonut','F')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png" class="share-icon"/>
              </button>
            </div>
            <canvas id="womenDonut"></canvas>
          </div>
          <div class="chart-container mt-6">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('womenHist','F')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png" class="share-icon"/>
              </button>
            </div>
            <canvas id="womenHist"></canvas>
          </div>
        </div>
      </div>

      <!-- MEN -->
      <div class="bg-black/60 rounded-lg p-4">
        <button onclick="toggleSection('men')" class="flex items-center justify-between w-full text-left text-lg font-bold">
          <span>Men</span>
          <svg id="arrow-men" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div id="men" class="collapsible-content mt-4">
          <select id="menSelect" class="p-2 rounded mb-4 text-sm"></select>
          <div class="chart-container">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('menDonut','M')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png" class="share-icon"/>
              </button>
            </div>
            <canvas id="menDonut"></canvas>
          </div>
          <div class="chart-container mt-6">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('menHist','M')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png" class="share-icon"/>
              </button>
            </div>
            <canvas id="menHist"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // MENU
    const menuBtn=document.getElementById('menu-btn'),mobileMenu=document.getElementById('mobile-menu');
    let menuVisible=false;
    menuBtn.addEventListener('click',e=>{menuVisible=!menuVisible;mobileMenu.classList.toggle('scale-y-0');e.stopPropagation();});
    document.addEventListener('click',e=>{if(!mobileMenu.contains(e.target)&&!menuBtn.contains(e.target)){menuVisible=false;mobileMenu.classList.add('scale-y-0');}});

    // DATA + CHARTS
    Chart.register(ChartDataLabels);
    const SHEET_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vSIS-QXBSLzVGyQYYIHf57zRmuSCSC9OmGSBMIOxhW2sB15SLTiVH_wPKcdThIoiqSulcypO1cf02HF/pub?gid=482892449&single=true&output=csv';
    let allData=[],charts={};

    Papa.parse(SHEET_URL,{download:true,header:true,complete:r=>{allData=r.data;setupDropdowns();}});

    function setupDropdowns(){
      ['F','M'].forEach(g=>{
        const d=allData.filter(r=>r.Gender===g);
        const classes=[...new Set(d.map(r=>r.Class))].sort((a,b)=>parseFloat(a)-parseFloat(b));
        const s=document.getElementById(g==='F'?'womenSelect':'menSelect');
        s.innerHTML=classes.map(c=>`<option value="${c}">${c}kg</option>`).join('');
        s.onchange=()=>renderCharts(g,s.value);
        renderCharts(g,classes[0]);
      });
    }

    function renderCharts(g,w){
      const f=allData.filter(r=>r.Gender===g&&r.Class===w);
      if(!f.length)return;

      const counts={};f.forEach(r=>counts[r.Athlete]=(counts[r.Athlete]||0)+1);
      const l=Object.keys(counts),v=Object.values(counts),t=v.reduce((a,b)=>a+b,0);
      const colors=['#ef4444','#f97316','#facc15','#22c55e','#14b8a6','#3b82f6','#8b5cf6','#ec4899','#06b6d4','#84cc16','#d946ef','#fb7185'];
      const id=g==='F'?'womenDonut':'menDonut';
      if(charts[id])charts[id].destroy();
      charts[id]=new Chart(document.getElementById(id),{
        type:'doughnut',
        data:{labels:l,datasets:[{data:v,backgroundColor:colors}]},
        options:{
          plugins:{
            title:{display:true,text:'Share of Votes',color:'#ccc'},
            subtitle:{display:true,text:`Total Votes â€“ ${t}`,color:'#aaa'},
            legend:{position:'bottom',labels:{color:'#ccc'}},
            datalabels:{color:'#fff',font:{weight:'bold'},formatter:x=>`${(x/t*100).toFixed(1)}%`}
          }
        },
        plugins:[ChartDataLabels]
      });

      const totals=f.map(r=>parseFloat(r.PredictedTotal)).filter(v=>!isNaN(v));
      const min=Math.min(...totals),max=Math.max(...totals),bins=Math.round(Math.sqrt(totals.length)),bw=(max-min)/bins,h=Array(bins).fill(0);
      totals.forEach(v=>{const i=Math.min(Math.floor((v-min)/bw),bins-1);h[i]++;});
      const lbls=Array.from({length:bins},(_,i)=>`${(min+i*bw).toFixed(0)}â€“${(min+(i+1)*bw).toFixed(0)}`),hid=g==='F'?'womenHist':'menHist';
      if(charts[hid])charts[hid].destroy();
      charts[hid]=new Chart(document.getElementById(hid),{
        type:'bar',
        data:{labels:lbls,datasets:[{data:h,backgroundColor:'#3b82f6',borderRadius:5}]},
        options:{plugins:{legend:{display:false},datalabels:{color:'#fff',font:{weight:'bold'},anchor:'center',align:'center',formatter:v=>v>0?v:''}}},
        plugins:[ChartDataLabels]
      });
    }

    async function shareChart(id,g){
      if(typeof window.QRCode==='undefined'){alert('QR code library not loaded');return;}

      const srcCanvas=document.getElementById(id);
      const s=document.getElementById(g==='F'?'womenSelect':'menSelect');
      const w=s.value;
      const titleMain='British Classic Fantasy League 2025 ðŸ‡¬ðŸ‡§';
      const titleSub=`${w}kg ${g==='F'?'Women':'Men'}`;
      const fn=`metrics_${g}_${w}_${id.includes('Donut')?'donut':'hist'}.png`;

      const img=new Image();img.src=srcCanvas.toDataURL();await img.decode();
      const card=document.createElement('div');
      Object.assign(card.style,{position:'relative',backgroundImage:"url('bc25_logo.jpg')",backgroundSize:'cover',backgroundPosition:'center',padding:'24px',borderRadius:'16px',color:'#fff',fontFamily:'Inter,sans-serif',maxWidth:'960px',margin:'0 auto',textAlign:'center',backgroundColor:'rgba(0,0,0,0.7)'});

      const h2=document.createElement('h2');h2.textContent=titleMain;h2.style.fontWeight='700';
      const p=document.createElement('p');p.textContent=titleSub;p.style.color='#ddd';
      img.style.borderRadius='8px';
      const credit=document.createElement('p');credit.innerHTML='Data from tinyurl.com/britishclassicfl-metrics<br><br>Sponsored by the Sabado Sessions Podcast';credit.style.color='#aaa';

      const qr=document.createElement('canvas');qr.width=75;qr.height=75;Object.assign(qr.style,{position:'absolute',bottom:'18px',left:'18px',opacity:'0.85',borderRadius:'8px'});
      await QRCode.toCanvas(qr,'https://britishclassicfantasyleague.github.io/metrics.html',{width:75,margin:1,color:{dark:'#fff',light:'rgba(0,0,0,0)'}});

      card.append(h2,p,img,credit,qr);document.body.appendChild(card);

      const snapshot=await html2canvas(card,{backgroundColor:null,scale:2,useCORS:true});
      card.remove();

      const blob=await new Promise(r=>snapshot.toBlob(r,'image/png'));
      const file=new File([blob],fn,{type:'image/png'});

      if(navigator.canShare&&navigator.canShare({files:[file]})){
        if(confirm('Share this chart image?')) await navigator.share({title:titleMain,files:[file]});
      }else alert('Sharing not supported on this device.');
    }
  </script>
</body>
</html>
