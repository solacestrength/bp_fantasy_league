<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Metrics | British Classic Fantasy League 2025 üá¨üáß</title>

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <link rel="stylesheet" href="assets/css/fix-dropdown.css" />

  <style>
    /* === GLOBAL THEME === */
    body {
      background: #0b0b0b;
      color: #f1f1f1;
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
    }

    /* === SELECTS === */
    select {
      background: #2f2f2f;
      border: 1px solid #555;
      color: #f1f1f1;
      padding: 0.35rem 0.5rem;
      border-radius: 0.375rem;
    }

    #womenSelect,
    #menSelect,
    .drill-select {
      background-color: rgba(31, 41, 55, 0.6) !important;
      border: 1px solid #374151;
      color: #f1f1f1;
    }

    .drill-select {
      display: inline-block;
      font-size: 0.75rem;
      padding: 0.4rem 0.6rem;
      max-width: 70%;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      vertical-align: middle;
    }

    /* === SHARE BUTTONS === */
    .share-btn {
      background-color: #dc2626;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: .5rem;
      height: 36px;
      width: 36px;
      margin-left: 0.4rem;
      transition: background-color .2s ease, transform .2s ease;
      vertical-align: middle;
    }

    .share-btn:hover {
      background-color: #ef4444;
      transform: translateY(-1px);
    }

    .share-icon {
      filter: invert(1);
      height: 18px;
      width: 18px;
    }

    /* === BACK PILL === */
    .back-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      padding: 0.5rem 1.1rem;
      border-radius: 999px;
      background-color: #111827;
      border: 1px solid #374151;
      color: #e5e7eb;
      font-size: 0.7rem;
      font-weight: 500;
      backdrop-filter: blur(6px);
      transition: all .2s ease;
    }

    .back-pill:hover {
      background-color: #374151;
      color: #f97316;
      transform: translateY(-1px);
    }

    /* === CHART CONTAINERS === */
    .chart-container {
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      transition: opacity 0.35s ease;
    }

    canvas {
      max-width: 100%;
      height: auto !important;
      display: block;
      margin: 0 auto;
    }

    /* Collapsibles */
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height .5s ease, opacity .4s ease;
    }

    .collapsible-content.open {
      opacity: 1;
      max-height: 1600px;
      padding-top: 0.75rem;
      padding-bottom: 0.75rem;
    }

    .arrow {
      transition: transform .3s ease;
    }

    .arrow.rotate {
      transform: rotate(180deg);
    }

    .hidden {
      display: none !important;
    }

    .fade-in {
      opacity: 1 !important;
    }

    .fade-out {
      opacity: 0 !important;
    }
  </style>
</head>

<body class="bg-gray-900 text-white font-sans min-h-screen flex flex-col">
  <!-- Background -->
  <div class="absolute inset-0 bg-[url('bc25_logo.jpg')] bg-cover bg-center opacity-45"></div>
  <div class="absolute inset-0 bg-black/70"></div>

  <div class="relative z-10 flex flex-col flex-grow">
    <!-- HEADER -->
    <header class="w-full bg-gray-900/90 backdrop-blur-sm border-b border-gray-800">
      <div class="w-full flex items-center justify-center px-4 py-3">
        <a href="index.html"
           class="font-bold text-white hover:text-red-500 transition text-lg md:text-2xl">
          British Classic Fantasy League 2025 üá¨üáß
        </a>
      </div>
    </header>

    <!-- MAIN -->
    <main class="max-w-5xl mx-auto p-6 space-y-8 mt-6">
      <section class="text-center">
        <h2 class="text-xl font-semibold mb-1">Metrics Dashboard</h2>
        <p class="text-gray-400 text-sm">
          Explore how the predicted winners and totals are distributed for a given weight class. Sample size = number of entrants.
          User note - any labels that appear from interacting with bars or chart sections will also be visible in your shared images.
          Double tap/double click doughnut segments for more charts üìä
        </p>
      </section>

      <!-- WOMEN SECTION -->
      <div class="bg-gray-800/60 border border-gray-700 backdrop-blur-sm shadow-lg rounded-2xl p-4">
        <button onclick="toggleSection('women')" class="flex items-center justify-between w-full text-left text-lg font-bold">
          <span>Women</span>
          <svg id="arrow-women" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <div id="women" class="collapsible-content mt-2">
          <!-- Class Select -->
          <div class="flex items-center justify-center mb-4">
            <select id="womenSelect" class="p-2 rounded text-sm"></select>
          </div>

          <!-- Donut -->
          <div class="chart-container" id="womenDonutContainer">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('womenDonut','F')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000"
                     class="share-icon" alt="Share" />
              </button>
            </div>
            <canvas id="womenDonut"></canvas>
          </div>

          <!-- Histogram -->
          <div class="chart-container mt-6" id="womenHistContainer">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('womenHist','F')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000"
                     class="share-icon" alt="Share" />
              </button>
            </div>
            <canvas id="womenHist"></canvas>
          </div>

          <!-- Drilldown -->
          <div class="chart-container mt-6 hidden" id="womenDrillContainer">
            <div class="flex items-center justify-center gap-2 mb-3">
              <select id="womenDrillSelect" class="drill-select"></select>
              <button class="share-btn" onclick="shareDrilldown('F')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000"
                     class="share-icon" alt="Share Drilldown" />
              </button>
            </div>
            <canvas id="womenDrill"></canvas>
            <div class="flex justify-center mt-4">
              <button class="back-pill" onclick="backToDonut('F')">‚Üê Back to Doughnut</button>
            </div>
          </div>
        </div>
      </div>

      <!-- MEN SECTION -->
      <div class="bg-gray-800/60 border border-gray-700 backdrop-blur-sm shadow-lg rounded-2xl p-4">
        <button onclick="toggleSection('men')" class="flex items-center justify-between w-full text-left text-lg font-bold">
          <span>Men</span>
          <svg id="arrow-men" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <div id="men" class="collapsible-content mt-2">
          <!-- Class Select -->
          <div class="flex items-center justify-center mb-4">
            <select id="menSelect" class="p-2 rounded text-sm"></select>
          </div>

          <!-- Donut -->
          <div class="chart-container" id="menDonutContainer">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('menDonut','M')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000"
                     class="share-icon" alt="Share" />
              </button>
            </div>
            <canvas id="menDonut"></canvas>
          </div>

          <!-- Histogram -->
          <div class="chart-container mt-6" id="menHistContainer">
            <div class="flex justify-end mb-1">
              <button class="share-btn" onclick="shareChart('menHist','M')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000"
                     class="share-icon" alt="Share" />
              </button>
            </div>
            <canvas id="menHist"></canvas>
          </div>

          <!-- Drilldown -->
          <div class="chart-container mt-6 hidden" id="menDrillContainer">
            <div class="flex items-center justify-center gap-2 mb-3">
              <select id="menDrillSelect" class="drill-select"></select>
              <button class="share-btn" onclick="shareDrilldown('M')">
                <img src="https://img.icons8.com/?size=100&id=qWomDF3YJPZv&format=png&color=000000"
                     class="share-icon" alt="Share Drilldown" />
              </button>
            </div>
            <canvas id="menDrill"></canvas>
            <div class="flex justify-center mt-4">
              <button class="back-pill" onclick="backToDonut('M')">‚Üê Back to Doughnut</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- VIEW LEADERBOARD -->
    <div class="flex justify-center mt-8">
      <a href="leaderboard.html"
         class="inline-flex items-center justify-center bg-gray-800/60 border border-gray-700
                text-gray-200 font-semibold px-6 py-3 rounded-full backdrop-blur-sm shadow-lg
                hover:bg-gray-700/70 hover:text-red-400 transition text-sm">
        View Leaderboard
      </a>
    </div>

    <!-- BACK TO TOP -->
    <div class="flex justify-center mt-8">
      <button id="bottomBackToTop"
              class="bg-gray-800/60 border border-gray-700 text-red-500 w-10 h-10 rounded-full
                     flex items-center justify-center backdrop-blur-sm shadow-lg
                     hover:bg-gray-700/70 hover:text-red-400 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
      </button>
    </div>

    <footer class="text-center text-gray-500 text-sm py-4 bg-transparent">
      Sponsored by the Sabado Sessions Podcast
    </footer>
  </div>

<script>
/* ========= CONFIG ========= */
const SHEET_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSIS-QXBSLzVGyQYYIHf57zRmuSCSC9OmGSBMIOxhW2sB15SLTiVH_wPKcdThIoiqSulcypO1cf02HF/pub?gid=482892449&single=true&output=csv';

let allData = [];
const charts = {};
const lastClick = {}; // for double-click detection

Chart.register(ChartDataLabels);

/* ========= SIZING ========= */
function sizing() {
  const d = window.matchMedia('(min-width:1024px)').matches;
  return {
    donutTitle:   d ? 22 : 16,
    donutSubtitle:d ? 18 : 14,
    donutLegend:  d ? 16 : 12,
    donutPercent: d ? 14 : 11,
    axisTitle:    d ? 16 : 12,
    axisTick:     d ? 12 : 10,
    barLabel:     d ? 12 : 10,
    exportWidth:  d ? 1100 : 780,
    headerFont:   d ? 30 : 22,
    subFont:      d ? 24 : 18,
    creditFont:   d ? 18 : 14,
    qrSize:       d ? 90 : 70
  };
}

/* ========= CSV LOAD ========= */
Papa.parse(SHEET_URL, {
  download: true,
  header: true,
  complete: (res) => {
    allData = res.data || [];
    setupDropdowns();
  }
});

/* ========= DROPDOWNS ========= */
function setupDropdowns() {
  ['F', 'M'].forEach(g => {
    const rows = allData.filter(r => r.Gender === g);
    const classes = [...new Set(rows.map(r => r.Class))].filter(Boolean)
      .sort((a,b)=>parseFloat(a)-parseFloat(b));
    const select = document.getElementById(g === 'F' ? 'womenSelect' : 'menSelect');
    if (!select || !classes.length) return;
    select.innerHTML = classes.map(c => `<option value="${c}">${c}kg</option>`).join('');
    select.onchange = () => renderCharts(g, select.value);
    renderCharts(g, classes[0]);
  });
}

/* ========= COLLAPSIBLES ========= */
function toggleSection(id) {
  const content = document.getElementById(id);
  const arrow = document.getElementById(`arrow-${id}`);
  if (!content || !arrow) return;
  const open = !content.classList.contains('open');
  content.classList.toggle('open', open);
  arrow.classList.toggle('rotate', open);
}

/* ========= DOUBLE-CLICK DETECTION ========= */
function isDoubleClick(key) {
  const now = Date.now();
  const diff = now - (lastClick[key] || 0);
  lastClick[key] = now;
  return diff < 320;
}

/* ========= RENDER CHARTS ========= */
function renderCharts(g, w) {
  const donutId = g === 'F' ? 'womenDonut' : 'menDonut';
  const histId  = g === 'F' ? 'womenHist'  : 'menHist';
  const donutContainer = document.getElementById(g === 'F' ? 'womenDonutContainer' : 'menDonutContainer');
  const drillContainer = document.getElementById(g === 'F' ? 'womenDrillContainer' : 'menDrillContainer');

  // Reset drill on class change
  if (drillContainer && !drillContainer.classList.contains('hidden')) {
    drillContainer.classList.add('hidden');
    if (donutContainer) donutContainer.classList.remove('hidden');
  }

  const rows = allData.filter(r => r.Gender === g && r.Class === w);
  if (!rows.length) return;

  /* --- DONUT DATA --- */
  const counts = {};
  rows.forEach(r => {
    if (!r.Athlete) return;
    counts[r.Athlete] = (counts[r.Athlete] || 0) + 1;
  });
  const labels = Object.keys(counts);
  const data = Object.values(counts);
  const total = data.reduce((a,b)=>a+b,0);

  const s = sizing();
  const colors = [
    '#ef4444','#f97316','#facc15','#22c55e','#14b8a6',
    '#3b82f6','#8b5cf6','#ec4899','#06b6d4','#84cc16',
    '#d946ef','#fb7185'
  ];

  if (charts[donutId]) charts[donutId].destroy();
  charts[donutId] = new Chart(document.getElementById(donutId), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors,
        borderColor: '#111',
        borderWidth: 1
      }]
    },
    options: {
      maintainAspectRatio: true,
      cutout: '57%',
      onClick: (evt, elements) => {
        if (!elements.length) return;
        const idx = elements[0].index;
        const athlete = labels[idx];
        const key = donutId + '-' + idx;
        if (isDoubleClick(key)) {
          openDrilldown(g, w, athlete);
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'Share of Votes',
          color: '#ffffff',
          font: { size: s.donutTitle, weight: 'bold' },
          align: 'center'
        },
        subtitle: {
          display: true,
          text: `Total Votes ‚Äì ${total}`,
          color: '#d1d5db',
          font: { size: s.donutSubtitle, weight: 'bold' },
          align: 'center',
          padding: { bottom: 16 }
        },
        legend: {
          position: 'bottom',
          labels: {
            color: '#e5e7eb',
            font: { size: s.donutLegend },
            boxWidth: 10,
            boxHeight: 10
          }
        },
        datalabels: {
          color: '#ffffff',
          font: { size: s.donutPercent, weight: 'bold' },
          formatter: (v) => {
            const pct = (v / total) * 100;
            return pct >= 3 ? `${pct.toFixed(1)}%` : '';
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  /* --- HISTOGRAM DATA --- */
  const vals = rows
    .map(r => parseFloat(r.PredictedTotal))
    .filter(v => !isNaN(v) && v > 0);
  if (!vals.length) {
    if (charts[histId]) charts[histId].destroy();
    return;
  }

  const N = vals.length;
  const min = Math.min(...vals);
  const max = Math.max(...vals);
  const bins = Math.max(3, Math.round(Math.sqrt(N)));
  const bw = (max - min) / bins || 1;
  const countsH = Array(bins).fill(0);

  vals.forEach(v => {
    let i = Math.floor((v - min) / bw);
    if (i >= bins) i = bins - 1;
    if (i < 0) i = 0;
    countsH[i]++;
  });

  const labelsH = Array.from({ length: bins }, (_, i) =>
    `${(min + i * bw).toFixed(0)}‚Äì${(min + (i + 1) * bw).toFixed(0)}`
  );

  const blues = labelsH.map((_, i) => {
    const t = bins > 1 ? i / (bins - 1) : 0;
    const r = Math.round(129 - 40 * t);
    const g = Math.round(200 - 80 * t);
    const b = Math.round(255 - 140 * t);
    return `rgb(${r},${g},${b})`;
  });

  if (charts[histId]) charts[histId].destroy();
  charts[histId] = new Chart(document.getElementById(histId), {
    type: 'bar',
    data: {
      labels: labelsH,
      datasets: [{
        data: countsH,
        backgroundColor: blues,
        borderRadius: 5
      }]
    },
    options: {
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        datalabels: {
          color: '#ffffff',
          font: { size: s.barLabel },
          formatter: (v) => (v > 0 ? v : ''),
          anchor: 'center',
          align: 'center'
        },
        tooltip: {
          callbacks: {
            label: ctx => `Vote Count - ${ctx.parsed.y}`
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#e5e7eb',
            font: { size: s.axisTick },
            maxRotation: 60,
            minRotation: 45
          },
          title: {
            display: true,
            text: 'Predicted Total (kg)',
            color: '#e5e7eb',
            font: { size: s.axisTitle, weight: 'bold' }
          },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: '#e5e7eb',
            font: { size: s.axisTick }
          },
          title: {
            display: true,
            text: `Vote Count (Total = ${N})`,
            color: '#e5e7eb',
            font: { size: s.axisTitle, weight: 'bold' }
          },
          grid: { display: false }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

/* ========= DRILLDOWN ========= */
function openDrilldown(g, w, athlete) {
  const drillId = g === 'F' ? 'womenDrill' : 'menDrill';
  const drillSelectId = g === 'F' ? 'womenDrillSelect' : 'menDrillSelect';
  const donutContainer = document.getElementById(g === 'F' ? 'womenDonutContainer' : 'menDonutContainer');
  const drillContainer = document.getElementById(g === 'F' ? 'womenDrillContainer' : 'menDrillContainer');

  // Populate dropdown with athletes in that class
  const rowsClass = allData.filter(r => r.Gender === g && r.Class === w && r.Athlete);
  const athletes = [...new Set(rowsClass.map(r => r.Athlete))];
  const drillSelect = document.getElementById(drillSelectId);
  drillSelect.innerHTML = athletes.map(a => `<option value="${a}">${a}</option>`).join('');
  drillSelect.value = athlete;
  drillSelect.onchange = () => openDrilldown(g, w, drillSelect.value);

  // Transition
  if (donutContainer && drillContainer) {
    donutContainer.classList.add('fade-out');
    setTimeout(() => {
      donutContainer.classList.add('hidden');
      drillContainer.classList.remove('hidden');
      drillContainer.classList.add('fade-in');
    }, 220);
  }

  // Build vote distribution for 1-16
  const rows = allData.filter(r =>
    r.Gender === g && r.Class === w && r.Athlete === athlete
  );

  const counts = {};
  for (let i = 1; i <= 16; i++) counts[i] = 0;
  rows.forEach(r => {
    const p = parseInt(r.Points, 10);
    if (!isNaN(p) && p >= 1 && p <= 16) counts[p]++;
  });

  const labels = Object.keys(counts).map(Number);
  const data = labels.map(k => counts[k]);
  const totalVotesClass = allData.filter(r => r.Gender === g && r.Class === w && r.Athlete).length;
  const votesForAthlete = data.reduce((a,b)=>a+b,0);

  const s = sizing();
  const reds = labels.map((_, i) => {
    const t = (labels.length > 1) ? i / (labels.length - 1) : 0;
    const r = Math.round(252 - 80 * t);
    const g = Math.round(165 - 80 * t);
    const b = Math.round(165 - 80 * t);
    return `rgb(${r},${g},${b})`;
  });

  if (charts[drillId]) charts[drillId].destroy();
  charts[drillId] = new Chart(document.getElementById(drillId), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: reds,
        borderRadius: 5
      }]
    },
    options: {
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        datalabels: {
          color: '#ffffff',
          font: { size: s.barLabel },
          formatter: (v) => (v > 0 ? v : ''),
          anchor: 'center',
          align: 'center'
        },
        tooltip: {
          callbacks: {
            label: ctx => `Vote Count - ${ctx.parsed.y}`
          }
        },
        title: {
          display: true,
          text: athlete,
          color: '#ffffff',
          font: { size: s.donutTitle, weight: 'bold' },
          align: 'center'
        },
        subtitle: {
          display: true,
          text: `Vote Count ‚Äì ${votesForAthlete} (out of ${totalVotesClass})`,
          color: '#d1d5db',
          font: { size: s.donutSubtitle, weight: 'bold' },
          align: 'center',
          padding: { bottom: 12 }
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#e5e7eb',
            font: { size: s.axisTick },
            maxRotation: 0,
            minRotation: 0
          },
          title: {
            display: true,
            text: 'Points / Confidence Level',
            color: '#e5e7eb',
            font: { size: s.axisTitle, weight: 'bold' }
          },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: '#e5e7eb',
            font: { size: s.axisTick }
          },
          title: {
            display: true,
            text: 'Vote Count',
            color: '#e5e7eb',
            font: { size: s.axisTitle, weight: 'bold' }
          },
          grid: { display: false }
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  // store for export use
  charts[drillId].$meta = {
    gender: g,
    weightClass: w,
    athlete,
    votesForAthlete,
    totalVotesClass
  };
}

function backToDonut(g) {
  const donutContainer = document.getElementById(g === 'F' ? 'womenDonutContainer' : 'menDonutContainer');
  const drillContainer = document.getElementById(g === 'F' ? 'womenDrillContainer' : 'menDrillContainer');
  if (!donutContainer || !drillContainer) return;

  drillContainer.classList.add('fade-out');
  setTimeout(() => {
    drillContainer.classList.add('hidden');
    donutContainer.classList.remove('hidden');
    donutContainer.classList.add('fade-in');
  }, 220);
}

/* ========= SHARE HELPERS ========= */
function detectBrowserShareSupport() {
  const ua = navigator.userAgent.toLowerCase();
  return {
    isAndroidChrome: ua.includes('android') && ua.includes('chrome') && !ua.includes('edge') && !ua.includes('opr'),
    isChromeIOS: ua.includes('crios')
  };
}

function sanitizeFilename(str) {
  return (str || 'share')
    .toString()
    .normalize('NFKD')
    .replace(/[^\w\-]+/g, '_')
    .replace(/_+/g, '_')
    .replace(/^_+|_+$/g, '')
    .toLowerCase();
}

/* ========= SHARE STANDARD CHARTS ========= */
async function shareChart(id, gender) {
  const s = sizing();
  const canvas = document.getElementById(id);
  if (!canvas) return;

  const chart = Chart.getChart(canvas);
  if (!chart) return;

  const isDonut = id.toLowerCase().includes('donut');
  const isHist  = id.toLowerCase().includes('hist');

  const classSelect = document.getElementById(gender === 'F' ? 'womenSelect' : 'menSelect');
  const weightVal = classSelect ? classSelect.value : '';
  const label = (weightVal ? `${weightVal}` : '') + (gender === 'F' ? ' Women' : ' Men');

  const dataURL = canvas.toDataURL('image/png');
  const img = new Image();
  img.src = dataURL;
  await img.decode();

  const card = document.createElement('div');
  card.style.position = 'relative';
  card.style.width = s.exportWidth + 'px';
  card.style.borderRadius = '24px';
  card.style.overflow = 'hidden';
  card.style.margin = '0 auto';
  card.style.backgroundImage = "url('bc25_logo.jpg')";
  card.style.backgroundSize = 'cover';
  card.style.backgroundPosition = 'center';
  card.style.boxShadow = '0 18px 45px rgba(0,0,0,0.65)';

  const overlay = document.createElement('div');
  overlay.style.position = 'absolute';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(0,0,0,0.78)';
  card.appendChild(overlay);

  const inner = document.createElement('div');
  inner.style.position = 'relative';
  inner.style.textAlign = 'center';
  inner.style.color = '#ffffff';
  inner.style.fontFamily = "'Inter', sans-serif";
  inner.style.zIndex = '2';
  inner.style.padding = '28px 26px 26px 26px';
  card.appendChild(inner);

  const h = document.createElement('h2');
  h.textContent = 'British Classic Fantasy League 2025 üá¨üáß';
  h.style.fontSize = s.headerFont + 'px';
  h.style.fontWeight = '700';
  h.style.margin = '0 0 4px 0';

  const sub = document.createElement('p');
  if (isDonut) {
    sub.textContent = `${label} ‚Äì Share of Votes`;
  } else if (isHist) {
    sub.innerHTML = `${label}<br>Distribution of Predicted Winning Totals`;
  } else {
    sub.textContent = label;
  }
  sub.style.fontSize = (s.subFont * 1.5) + 'px';
  sub.style.fontWeight = '600';
  sub.style.color = '#e5e7eb';
  sub.style.margin = '0 0 18px 0';

  img.style.display = 'block';
  img.style.margin = '0 auto 16px auto';
  img.style.borderRadius = '16px';
  img.style.width = isDonut ? '72%' : '92%';
  img.style.height = 'auto';

  const credit = document.createElement('p');
  credit.style.fontSize = (s.creditFont * 1.5) + 'px';
  credit.style.color = '#d1d5db';
  credit.style.lineHeight = '1.5';
  credit.style.marginTop = '6px';
  credit.innerHTML =
    'Data from tinyurl.com/britishclassicfl-metrics<br/>Sponsored by the Sabado Sessions Podcast';

  const qr = new Image();
  qr.src = `https://api.qrserver.com/v1/create-qr-code/?size=${s.qrSize}x${s.qrSize}&data=${encodeURIComponent('https://solacestrength.github.io/britishclassicfl/metrics.html')}`;
  qr.style.position = 'absolute';
  qr.style.left = '18px';
  qr.style.bottom = '18px';
  qr.style.width = s.qrSize + 'px';
  qr.style.height = s.qrSize + 'px';
  qr.style.borderRadius = '6px';

  inner.appendChild(h);
  inner.appendChild(sub);
  inner.appendChild(img);
  inner.appendChild(credit);
  card.appendChild(qr);
  document.body.appendChild(card);

  await new Promise(r => requestAnimationFrame(r));
  const exportCanvas = await html2canvas(card, { backgroundColor: null, scale: 2, useCORS: true });
  card.remove();

  const blob = await new Promise(res => exportCanvas.toBlob(res, 'image/png'));
  const fn = `${sanitizeFilename(id)}_${sanitizeFilename(label)}.png`;
  const file = new File([blob], fn, { type: 'image/png' });

  const { isChromeIOS } = detectBrowserShareSupport();

  try {
    if (navigator.canShare && navigator.canShare({ files: [file] }) && !isChromeIOS) {
      await navigator.share({
        title: 'British Classic Fantasy League 2025',
        text: 'Check out these stats!',
        files: [file]
      });
    } else {
      const url = URL.createObjectURL(file);
      const a = document.createElement('a');
      a.href = url;
      a.download = fn;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  } catch (err) {
    console.error(err);
  }
}

/* ========= SHARE DRILLDOWN ========= */
async function shareDrilldown(g) {
  const drillId = g === 'F' ? 'womenDrill' : 'menDrill';
  const chart = Chart.getChart(document.getElementById(drillId));
  if (!chart || !chart.$meta) return;
  const s = sizing();

  const { athlete, votesForAthlete, totalVotesClass, weightClass } = chart.$meta;
  const canvas = chart.canvas;
  const dataURL = canvas.toDataURL('image/png');
  const img = new Image();
  img.src = dataURL;
  await img.decode();

  const card = document.createElement('div');
  card.style.position = 'relative';
  card.style.width = s.exportWidth + 'px';
  card.style.borderRadius = '24px';
  card.style.overflow = 'hidden';
  card.style.margin = '0 auto';
  card.style.backgroundImage = "url('bc25_logo.jpg')";
  card.style.backgroundSize = 'cover';
  card.style.backgroundPosition = 'center';
  card.style.boxShadow = '0 18px 45px rgba(0,0,0,0.65)';

  const overlay = document.createElement('div');
  overlay.style.position = 'absolute';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(0,0,0,0.78)';
  card.appendChild(overlay);

  const inner = document.createElement('div');
  inner.style.position = 'relative';
  inner.style.textAlign = 'center';
  inner.style.color = '#ffffff';
  inner.style.fontFamily = "'Inter', sans-serif";
  inner.style.zIndex = '2';
  inner.style.padding = '28px 26px 26px 26px';
  card.appendChild(inner);

  const h = document.createElement('h2');
  h.textContent = 'British Classic Fantasy League 2025 üá¨üáß';
  h.style.fontSize = s.headerFont + 'px';
  h.style.fontWeight = '700';
  h.style.margin = '0 0 4px 0';

  const sub1 = document.createElement('p');
  sub1.textContent = athlete;
  sub1.style.fontSize = (s.subFont * 1.5) + 'px';
  sub1.style.fontWeight = '600';
  sub1.style.color = '#e5e7eb';
  sub1.style.margin = '0 0 4px 0';

  const sub2 = document.createElement('p');
  sub2.textContent = `${votesForAthlete} votes out of ${totalVotesClass}`;
  sub2.style.fontSize = (s.subFont * 0.9) + 'px';
  sub2.style.fontWeight = '500';
  sub2.style.color = '#d1d5db';
  sub2.style.margin = '0 0 16px 0';

  img.style.display = 'block';
  img.style.margin = '0 auto 16px auto';
  img.style.borderRadius = '16px';
  img.style.width = '92%';
  img.style.height = 'auto';

  const credit = document.createElement('p');
  credit.style.fontSize = (s.creditFont * 1.5) + 'px';
  credit.style.color = '#d1d5db';
  credit.style.lineHeight = '1.5';
  credit.style.marginTop = '6px';
  credit.innerHTML =
    'Data from tinyurl.com/britishclassicfl-metrics<br /><br />Sponsored by the Sabado Sessions Podcast';

  const qr = new Image();
  qr.src = `https://api.qrserver.com/v1/create-qr-code/?size=${s.qrSize}x${s.qrSize}&data=${encodeURIComponent('https://solacestrength.github.io/britishclassicfl/metrics.html')}`;
  qr.style.position = 'absolute';
  qr.style.left = '18px';
  qr.style.bottom = '18px';
  qr.style.width = s.qrSize + 'px';
  qr.style.height = s.qrSize + 'px';
  qr.style.borderRadius = '6px';

  inner.appendChild(h);
  inner.appendChild(sub1);
  inner.appendChild(sub2);
  inner.appendChild(img);
  inner.appendChild(credit);
  card.appendChild(qr);
  document.body.appendChild(card);

  await new Promise(r => requestAnimationFrame(r));
  const exportCanvas = await html2canvas(card, { backgroundColor: null, scale: 2, useCORS: true });
  card.remove();

  const blob = await new Promise(res => exportCanvas.toBlob(res, 'image/png'));
  const fn = `drilldown_${sanitizeFilename(athlete)}.png`;
  const file = new File([blob], fn, { type: 'image/png' });

  const { isChromeIOS } = detectBrowserShareSupport();

  try {
    if (navigator.canShare && navigator.canShare({ files: [file] }) && !isChromeIOS) {
      await navigator.share({
        title: 'British Classic Fantasy League 2025 ‚Äì Drilldown',
        text: 'Vote distribution drilldown.',
        files: [file]
      });
    } else {
      const url = URL.createObjectURL(file);
      const a = document.createElement('a');
      a.href = url;
      a.download = fn;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  } catch (err) {
    console.error(err);
  }
}

/* ========= BACK TO TOP ========= */
document.getElementById('bottomBackToTop')
  .addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
</script>
</body>
</html>
